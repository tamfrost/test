# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI

on:
  push:
    branches: [ "main", "2-a-new-feature" ]
  pull_request:
    branches: [ "main", "2-a-new-feature" ]

jobs:

  docker-dind-test:
    runs-on: [self-hosted, ubuntu]
    container:
      image: docker:20.10.16
    services:
      docker:
        image: docker:20.10.16-dind
        options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: show info
        shell: sh
        run: |
          docker info


  docker-test:
    runs-on: [self-hosted, ubuntu]
    container:
      image: node:22.13.0
    steps:
      - name: checkout code
        uses: actions/checkout@v4
      - name: show versions
        shell: bash
        run: |
          node --version
          npm --version

  build:
    runs-on: [self-hosted, ubuntu]
    container:
      image: node:22.13.0
    steps:
      - name: checkout code
        uses: actions/checkout@v4
      - name: build and test
        shell: bash
        run: |
             npm ci
             npm run build --if-present
             npm test

  publish:
    runs-on: [self-hosted, ubuntu]
    environment: production
    container:
      image: node:22.13.0
    steps:
      - name: checkout code
        uses: actions/checkout@v4
      - name: publish
        shell: bash
        run: |
             echo ${{ secrets.NPMRC }} | base64 --decode > ~/.npmrc
             npm publish